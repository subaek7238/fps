import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

// -------------------- 씬, 카메라, 렌더러 --------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f0f0);

const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(0, 2, 10); // 약간 높게 해서 FPS 느낌
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// -------------------- 조명 --------------------
const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
directionalLight.position.set(5, 10, 7.5);
scene.add(directionalLight);

// -------------------- 바닥 --------------------
const floorGeometry = new THREE.PlaneGeometry(20, 20);
const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
const floor = new THREE.Mesh(floorGeometry, floorMaterial);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

// -------------------- 벽 --------------------
const wallMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
const wallHeight = 5;
const wallThickness = 0.5;

// 앞벽
const frontWall = new THREE.Mesh(new THREE.BoxGeometry(20, wallHeight, wallThickness), wallMaterial);
frontWall.position.set(0, wallHeight / 2, -10);
scene.add(frontWall);

// 뒤벽
const backWall = new THREE.Mesh(new THREE.BoxGeometry(20, wallHeight, wallThickness), wallMaterial);
backWall.position.set(0, wallHeight / 2, 10);
scene.add(backWall);

// 왼쪽벽
const leftWall = new THREE.Mesh(new THREE.BoxGeometry(wallThickness, wallHeight, 20), wallMaterial);
leftWall.position.set(-10, wallHeight / 2, 0);
scene.add(leftWall);

// 오른쪽벽
const rightWall = new THREE.Mesh(new THREE.BoxGeometry(wallThickness, wallHeight, 20), wallMaterial);
rightWall.position.set(10, wallHeight / 2, 0);
scene.add(rightWall);

// -------------------- 빨간 박스 --------------------
const boxMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
const boxes = [];

const boxPositions = [
  new THREE.Vector3(-5, 0.5, 0),
  new THREE.Vector3(0, 0.5, 0),
  new THREE.Vector3(5, 0.5, 0)
];

boxPositions.forEach(pos => {
  const box = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), boxMaterial);
  box.position.copy(pos);
  scene.add(box);
  boxes.push(box);
});

// -------------------- 클릭 이벤트 --------------------
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function handleClick(event) {
  // 화면 좌표 -> 정규화 좌표
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(boxes);

  if (intersects.length > 0) {
    // 클릭한 박스 제거
    const clickedBox = intersects[0].object;
    scene.remove(clickedBox);
    boxes.splice(boxes.indexOf(clickedBox), 1);

    // 새로운 박스 생성 (랜덤 위치)
    const newBox = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), boxMaterial);
    const x = (Math.random() - 0.5) * 18; // -9 ~ 9
    const z = (Math.random() - 0.5) * 18;
    newBox.position.set(x, 0.5, z);
    scene.add(newBox);
    boxes.push(newBox);
  }
}

window.addEventListener('click', handleClick);

// 모바일용 총 버튼 클릭도 동일 처리
const shootBtn = document.getElementById('shootBtn');
shootBtn.addEventListener('click', (e) => {
  // 모바일 터치 좌표는 중앙으로 설정 (FPS 느낌)
  mouse.x = 0;
  mouse.y = 0;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(boxes);

  if (intersects.length > 0) {
    const clickedBox = intersects[0].object;
    scene.remove(clickedBox);
    boxes.splice(boxes.indexOf(clickedBox), 1);

    const newBox = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), boxMaterial);
    const x = (Math.random() - 0.5) * 18;
    const z = (Math.random() - 0.5) * 18;
    newBox.position.set(x, 0.5, z);
    scene.add(newBox);
    boxes.push(newBox);
  }
});

// -------------------- 애니메이션 루프 --------------------
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}

animate();

// -------------------- 리사이즈 대응 --------------------
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
